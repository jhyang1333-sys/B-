# 哈密顿算符积分映射说明

本文档整理论文公式 (2.37) 等与数值实现所需的 `I/J/Q` 积分之间的对应关系，便于在 `MatrixElementBuilder` 中逐项落地。

## 记号约定

- Ket 基函数：\(|\Psi_j\rangle = B_k(r_1) B_l(r_2) r_{12}^{c_j} \Lambda_j(\Omega_1,\Omega_2)\)
- Bra 基函数：\(\langle\Psi_i| = \langle B_i(r_1) B_j(r_2) r_{12}^{c_i} \Lambda_i|\)
- 有效关联幂：\(c_{ij}^{(n)} = c_i + c_j + n\)
- 样条导数：`B_k'`, `B_k"` 等对应代码中的一阶、二阶导数
- 角向积分：\(\mathcal{A}^{(\cdot)}_{ij}(q)\) 表示论文给出的角向张量（代码中由 `angular_tensor_*` 函数提供）

## 1. 纯 \(r_{12}\) 导数项

| 算符                                                                     | 作用结果（系数）                                        | 积分类型             |
| ------------------------------------------------------------------------ | ------------------------------------------------------- | -------------------- |
| \((\tfrac{1}{M}-\tfrac{1}{\mu})\,\partial_{r_{12}}^{2}\)                 | \(c_j(c_j-1)\,r_{12}^{c_j-2}\)                          | \(I(c_{ij}^{(-2)})\) |
| \(2(\tfrac{1}{M}-\tfrac{1}{\mu})\,\tfrac{1}{r_{12}}\partial_{r_{12}}\)   | \(2(\tfrac{1}{M}-\tfrac{1}{\mu})\,c_j\,r_{12}^{c_j-2}\) | \(I(c_{ij}^{(-2)})\) |
| 质量极化中的 \(-\partial_{r_{12}}^{2} - 2 r_{12}^{-1}\partial_{r_{12}}\) | 分别产生 \(-c_j(c_j-1)\)、\(-2c_j\)                     | \(I(c_{ij}^{(-2)})\) |

这些项累加后全部映射到同一个 `I` 积分，区别只在于系数。

## 2. 纯 \(r_1\)、\(r_2\) 导数项

论文式 (2.37) 中的 \(\partial/\partial r_1\)、\(\partial^2/\partial r_1^2\) 等算符已经在坐标变换后独立定义，不再对 \(r_{12}\) 施加链式法则。因此：

| 算符                                        | 作用结果                                                    | 对应积分            |
| ------------------------------------------- | ----------------------------------------------------------- | ------------------- |
| \(-\tfrac{1}{2\mu}\,\partial_{r_1}^{2}\)    | 仅作用于 \(B_k(r_1)\)，得到 \(B_k''(r_1)\,r_{12}^{c_j}\)    | \(I(c_{ij}^{(0)})\) |
| \(-\tfrac{1}{\mu}\,r_1^{-1}\partial_{r_1}\) | 仅作用于 \(B_k(r_1)\)，得到 \(B_k'(r_1)/r_1\,r_{12}^{c_j}\) | \(I(c_{ij}^{(0)})\) |
| \(r_2\) 的同类项                            | 对称于上                                                    | \(I(c_{ij}^{(0)})\) |

所有涉及 \(r_1\) 或 \(r_2\) 的纯径向导数都只在样条函数上产生导数，\(r_{12}\) 幂次保持不变。

## 3. 混合二阶导数项

| 算符                                                                                                                   | 行为                                                                                                                         | 积分类型           |
| ---------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | ------------------ |
| \(\tfrac{1}{2}(\tfrac{1}{M}-\tfrac{1}{\mu})\tfrac{r_1^2-r_2^2+r_{12}^2}{r_1 r_{12}}\,\partial_{r_1}\partial_{r_{12}}\) | \(\partial_{r_1}\) 作用于样条 \(B_k\)，\(\partial_{r_{12}}\) 作用于 \(r_{12}^{c_j}\)，得到 \(B_k'(r_1)\,c_j r_{12}^{c_j-1}\) | `I(c_{ij}^{(-1)})` |
| \(\tfrac{1}{2}(\tfrac{1}{M}-\tfrac{1}{\mu})\tfrac{r_2^2-r_1^2+r_{12}^2}{r_2 r_{12}}\,\partial_{r_2}\partial_{r_{12}}\) | 同理（互换 1,2）                                                                                                             | `I(c_{ij}^{(-1)})` |
| \(-\tfrac{1}{2M}\tfrac{r_1^2+r_2^2-r_{12}^2}{2 r_1 r_2}\,\partial_{r_1}\partial_{r_2}\)                                | \(\partial_{r_1}\partial_{r_2}\) 仅作用于样条，产生 \(B_k'(r_1) B_l'(r_2) r_{12}^{c_j}\)                                     | `I(c_{ij}^{(0)})`  |

几何系数中的 \(r_1,r_2,r_{12}\) 需借助勒让德展开重写为 \(r_<, r_>\) 幂次组合。

## 4. 角向耦合项

| 算符                                                                                                                                       | 作用结果                                                                | 积分类型                                |
| ------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------- | --------------------------------------- |
| \([-\tfrac{1}{M r_2}\partial_{r_1} + (\tfrac{1}{\mu}-\tfrac{1}{M})\tfrac{r_1}{r_2 r_{12}}\partial_{r_{12}}](\hat r_1\cdot\hat\nabla_2^Y)\) | 分别得到 \(B_k' r_{12}^{c_j}\) 与 \(B_k c_j r_{12}^{c_j-2}\) 乘角向张量 | `J(c_{ij}^{(0)})` 与 `J(c_{ij}^{(-2)})` |
| \([-\tfrac{1}{M r_1}\partial_{r_2} + (\tfrac{1}{\mu}-\tfrac{1}{M})\tfrac{r_2}{r_1 r_{12}}\partial_{r_{12}}](\hat r_2\cdot\hat\nabla_1^Y)\) | 同理                                                                    | 同理                                    |
| \(-\tfrac{1}{M r_1 r_2}(\hat\nabla_1^Y\cdot\hat\nabla_2^Y)\)                                                                               | 无径向导数，仅角向张量 × \(r_{12}^{c_j}\)                               | `J(c_{ij}^{(0)})`                       |

哈密顿量本身不涉及 `Q` 型积分（那是偶极算符相关的扩展）。

## 5. 势能项

| 项                                   | 映射                                                   |
| ------------------------------------ | ------------------------------------------------------ |
| \(-\tfrac{2}{r_1} - \tfrac{2}{r_2}\) | 直接对应 `I(c_{ij}^{(0)})`（当前实现已正确处理）       |
| \(+\tfrac{1}{r_{12}}\)               | 映射到 `I(c_{ij}^{(-1)})`，即我们已新增的电子-电子势项 |

---

## 实现建议

1. **结构拆分**：在 `MatrixElementBuilder` 中按算符分组实现，对每个算符调用统一的 `evaluate_I/J` 助手，避免在单个 `integrand` 内混杂所有逻辑。
2. **复用现有组件**：`CorrelationExpansion`（已支持 \(c=-1\)）负责生成勒让德展开系数；`angular_tensor_*` 提供角向积分；`RadialQuadrature2D` 继续承担数值求积。


问题在于，像 $\frac{r_1^2-r_2^2+r_{12}^2}{r_1 r_{12}}$ 这样的“几何因子” *本身* 依赖于 $r_{12}$，它必须先与基函数 $r_{12}^c$ 合并，**然后**才能应用勒让德展开（式 2.41）。

以下就是需要的、将论文 (2.37) 为可编码的 $I$ 和 $J$ 积分  的**“最终系数”**推导。

### 1. 混合二阶导数项 ( $I$ 积分)



#### A. $\partial_{r_1}\partial_{r_{12}}$ 项

* **算符 $H_n$**：$C_{M\mu} \cdot (\frac{r_1^2-r_2^2+r_{12}^2}{r_1 r_{12}}) \cdot \partial_{r_1}\partial_{r_{12}}$
    * 其中 $C_{M\mu} = \frac{1}{2}(\frac{1}{M}-\frac{1}{\mu})$
* **矩阵元被积函数**：$\langle \Psi_i | H_n | \Psi_j \rangle$ 的径向部分为：
    $(B_i B_j)^* \cdot C_{M\mu} \cdot (\frac{r_1^2-r_2^2+r_{12}^2}{r_1 r_{12}}) \cdot (B_k' B_l) \cdot (c_j r_{12}^{c_j-1}) \cdot r_{12}^{c_i}$
* **代数化简 (关键)**：我们合并 $r_{12}$ 项：
    $C_{M\mu} \cdot c_j \cdot (B_i B_j)^* (B_k' B_l) \cdot [(\frac{r_1^2-r_2^2}{r_1 r_{12}}) r_{12}^{c_i + c_j - 1} + (\frac{r_{12}}{r_1}) r_{12}^{c_i + c_j - 1}]$
    $C_{M\mu} \cdot c_j \cdot (B_i B_j)^* (B_k' B_l) \cdot [(\frac{r_1^2-r_2^2}{r_1}) r_{12}^{c_{ij}^{(-2)}} + (\frac{1}{r_1}) r_{12}^{c_{ij}^{(0)}}]$
* **映射 (您需要的系数)**：此算符项**分裂**为两个 $I$ 积分的贡献：
    1.  **$I(c_{ij}^{(-2)})$ 型**：
        * **径向 prefactor $P(r_1, r_2)$**：$C_{M\mu} \cdot c_j \cdot (\frac{r_1^2-r_2^2}{r_1}) \cdot (\frac{B_k' B_l}{B_k B_l})$
    2.  **$I(c_{ij}^{(0)})$ 型**：
        * **径向 prefactor $P(r_1, r_2)$**：$C_{M\mu} \cdot c_j \cdot (\frac{1}{r_1}) \cdot (\frac{B_k' B_l}{B_k B_l})$

#### B. $\partial_{r_1}\partial_{r_2}$ 项

* **算符 $H_n$**：$C_{M} \cdot (\frac{r_1^2+r_2^2-r_{12}^2}{r_1 r_2}) \cdot \partial_{r_1}\partial_{r_2}$
    * 其中 $C_{M} = -\frac{1}{4M}$
* **矩阵元被积函数**：
    $(B_i B_j)^* \cdot C_{M} \cdot (\frac{r_1^2+r_2^2-r_{12}^2}{r_1 r_2}) \cdot (B_k' B_l') \cdot r_{12}^{c_i + c_j}$
* **代数化简**：
    $C_{M} \cdot (B_i B_j)^* (B_k' B_l') \cdot [(\frac{r_1^2+r_2^2}{r_1 r_2}) r_{12}^{c_{ij}^{(0)}} - (\frac{1}{r_1 r_2}) r_{12}^{c_{ij}^{(2)}}]$
* **映射 (您需要的系数)**：此算符项**分裂**为两个 $I$ 积分的贡献：
    1.  **$I(c_{ij}^{(0)})$ 型**：
        * **径向 prefactor $P(r_1, r_2)$**：$C_{M} \cdot (\frac{r_1^2+r_2^2}{r_1 r_2}) \cdot (\frac{B_k' B_l'}{B_k B_l})$
    2.  **$I(c_{ij}^{(2)})$ 型**：
        * **径向 prefactor $P(r_1, r_2)$**：$C_{M} \cdot (-\frac{1}{r_1 r_2}) \cdot (\frac{B_k' B_l'}{B_k B_l})$

---

### 2. 角向耦合项 ( $J$ 积分)

这是您缺少的**“prefactor 拆分”**。您必须为 $J_1, J_2, J_3$ 型积分 [cite: 411-416] 分别计算其径向部分。

#### A. $(\hat{r}_1 \cdot \hat{\nabla}_2^Y)$ 耦合项 ( $J_1$ 型 )

* **算符 $H_{J1}$**：$\left[-\frac{1}{Mr_{2}}\partial_{r_{1}} + (\frac{1}{\mu}-\frac{1}{M})\frac{r_{1}}{r_{2}r_{12}}\partial_{r_{12}}\right](\hat{r}_{1}\cdot\hat{\nabla}_{2}^{Y})$
* 此算符分裂为两个 $J$ 积分的贡献：
    1.  **$J(c_{ij}^{(0)})$ 型** (来自 $\partial_{r_1}$)：
        * **角向系数 (每个 $q$ )**：`angular.angular_tensor_rhat_grad_12(..., q)`
        * **径向 prefactor $P(r_1, r_2)$**：$(-\frac{1}{Mr_2}) \cdot (\frac{B_k' B_l}{B_k B_l})$
    2.  **$J(c_{ij}^{(-2)})$ 型** (来自 $\partial_{r_{12}}$)：
        * **角向系数 (每个 $q$ )**：`angular.angular_tensor_rhat_grad_12(..., q)`
        * **径向 prefactor $P(r_1, r_2)$**：$(\frac{1}{\mu}-\frac{1}{M}) \cdot c_j \cdot (\frac{r_1}{r_2})$
        * (推导：$\frac{r_1}{r_2 r_{12}} \cdot (c_j r_{12}^{c_j-1}) \cdot r_{12}^{c_i} = c_j \frac{r_1}{r_2} r_{12}^{c_{ij}^{(-2)}}$)

#### B. $(\hat{r}_2 \cdot \hat{\nabla}_1^Y)$ 耦合项 ( $J_2$ 型 )

* **算符 $H_{J2}$**：$\left[-\frac{1}{Mr_{1}}\partial_{r_{2}} + (\frac{1}{\mu}-\frac{1}{M})\frac{r_{2}}{r_{1}r_{12}}\partial_{r_{12}}\right](\hat{r}_{2}\cdot\hat{\nabla}_{1}^{Y})$
* 与 A 项对称：
    1.  **$J(c_{ij}^{(0)})$ 型** (来自 $\partial_{r_2}$)：
        * **角向系数 (每个 $q$ )**：`angular.angular_tensor_rhat_grad_21(..., q)`
        * **径向 prefactor $P(r_1, r_2)$**：$(-\frac{1}{Mr_1}) \cdot (\frac{B_k B_l'}{B_k B_l})$
    2.  **$J(c_{ij}^{(-2)})$ 型** (来自 $\partial_{r_{12}}$)：
        * **角向系数 (每个 $q$ )**：`angular.angular_tensor_rhat_grad_21(..., q)`
        * **径向 prefactor $P(r_1, r_2)$**：$(\frac{1}{\mu}-\frac{1}{M}) \cdot c_j \cdot (\frac{r_2}{r_1})$

#### C. $(\hat{\nabla}_1^Y \cdot \hat{\nabla}_2^Y)$ 耦合项 ( $J_3$ 型 )

* **算符 $H_{J3}$**：$-\frac{1}{Mr_{1}r_{2}}(\hat{\nabla}_{1}^{Y}\cdot\hat{\nabla}_{2}^{Y})$
* 此项只有一个贡献：
    1.  **$J(c_{ij}^{(0)})$ 型**：
        * **角向系数 (每个 $q$ )**：`angular.angular_tensor_grad_grad(..., q)`
        * **径向 prefactor $P(r_1, r_2)$**：$-\frac{1}{Mr_1 r_2}$

---

### 总结与下一步

现在拥有了将 (2.37) 映射到 $I/J$ 积分  所需的**全部**代数系数和拆分规则。

