# 哈密顿算符构造与积分映射指南

本文档补充论文公式 (2.37) 中未展开的细节，聚焦于氦原子哈密顿量中**最困难、最易出错的构造环节**：如何把含有复杂几何因子的算符转写为数值实现所需的 `I`/`J` 积分。下列推导直接支撑 `MatrixElementBuilder` 的实现。

> **使用方式**：若需快速定位某一算符的实现，可先查阅第 3 节的分组表，再跳转到具体小节；若要整体复核实现流程，可按 1 → 2 → 6 → 7 → 9 的顺序阅读。

## 1. 总览

### 1.1 目标

把矩阵元 \(\langle \Psi_i | H | \Psi_j \rangle\) 分解成可复用的径向积分 `I(c_{ij}^{(n)})` 与角向积分 `J(c_{ij}^{(n)})`，便于在代码中复用统一的积分器与缓存逻辑。

### 1.2 核心策略

1. **算符分组**：先按类型拆分（纯径向、混合导数、角向耦合、势能）。
2. **幂次管理**：遇到 \(r_{12}\) 相关几何因子时，**先**与基函数幂次合并，得到标准形 \(r_{12}^{c_{ij}^{(n)}}\)。
3. **积分映射**：将得到的幂次映射到 `I(c_{ij}^{(n)})` 或 `J(c_{ij}^{(n)})`，并登记径向前因子、角向张量。

### 1.3 复杂点聚焦

- 带有 \(\tfrac{r_1^2 \pm r_2^2 + r_{12}^2}{r_1 r_{12}}\) 的混合导数项需要拆成多个积分通道。
- 角向耦合需要同步维护 `q` 循环、径向前因子与角向张量，稍有遗漏就会导致系数错误。
- 勒让德展开必须基于 \(r_<\) 与 \(r_>\)（较小与较大径向变量）的幂次组合，因此所有含 \(r_{12}\) 的几何因子都要先完成幂次合并，再交给 `CorrelationExpansion`。

### 1.4 实现流程概览

```text
1) 解析算符 → 2) 识别几何因子 → 3) 合并 r12 幂次 →
4) 拆分成若干 I/J 通道 → 5) 累加到 MatrixElementBuilder
```

## 2. 记号规范

- Ket 基函数：\(|\Psi_j\rangle = B_k(r_1) B_l(r_2) r_{12}^{c_j} \Lambda_j(\Omega_1,\Omega_2)\)
- Bra 基函数：\(\langle\Psi_i| = \langle B_i(r_1) B_j(r_2) r_{12}^{c_i} \Lambda_i|\)
- 有效关联幂：\(c_{ij}^{(n)} = c_i + c_j + n\)
- 样条导数：`B_k'`, `B_k"` 对应代码中的一阶、二阶导数
- 角向张量：`angular_tensor_*` 函数返回的 \(\mathcal{A}^{(\cdot)}_{ij}(q)\)

## 3. 算符分组概览

| 组别                     | 代表算符                                                           | 积分类型 |
| ------------------------ | ------------------------------------------------------------------ | -------- |
| 纯 \(r_{12}\) 导数       | \(\partial_{r_{12}},\ \partial_{r_{12}}^2\)                        | `I`      |
| 纯 \(r_1/r_2\) 导数      | \(\partial_{r_1},\ \partial_{r_1}^2\)（对称于 \(r_2\)）            | `I`      |
| **混合导数**（核心难点） | \(\partial_{r_1}\partial_{r_{12}},\ \partial_{r_1}\partial_{r_2}\) | `I`      |
| 角向耦合                 | \(\hat r\cdot\hat\nabla^Y\), \(\hat\nabla^Y\cdot\hat\nabla^Y\)     | `J`      |
| 势能项                   | \( -2/r_1 - 2/r_2 + 1/r_{12} \)                                    | `I`      |

下文按这一顺序逐项展开，重点放在混合导数和角向耦合的拆分。

## 4. 纯 \(r_{12}\) 导数

这类算符只改变 \(r_{12}\) 的幂次，步骤相对直接。公用的积分模板为：

\[
I\big(c_{ij}^{(n)}\big) = \int dr_1 dr_2\, B_i(r_1) B_j(r_2) B_k(r_1) B_l(r_2)\, r_{12}^{c_{ij}^{(n)}}
\]

| 算符                                                                     | 系数量化                                                      | 积分               |
| ------------------------------------------------------------------------ | ------------------------------------------------------------- | ------------------ |
| \((\tfrac{1}{M}-\tfrac{1}{\mu})\,\partial_{r_{12}}^{2}\)                 | \(c_j(c_j-1) r_{12}^{c_{ij}^{(-2)}}\)                         | `I(c_{ij}^{(-2)})` |
| \(2(\tfrac{1}{M}-\tfrac{1}{\mu})\,r_{12}^{-1}\partial_{r_{12}}\)         | \(2(\tfrac{1}{M}-\tfrac{1}{\mu}) c_j r_{12}^{c_{ij}^{(-2)}}\) | `I(c_{ij}^{(-2)})` |
| 质量极化中的 \(-\partial_{r_{12}}^{2} - 2 r_{12}^{-1}\partial_{r_{12}}\) | 合并得到 \(-c_j(c_j-1) - 2c_j\)                               | `I(c_{ij}^{(-2)})` |

所有项合并到同一个 `I(c_{ij}^{(-2)})` 通道，只需记录各自的前系数。

## 5. 纯 \(r_1\)、\(r_2\) 导数

| 算符                                        | 行为                                                                  | 积分              |
| ------------------------------------------- | --------------------------------------------------------------------- | ----------------- |
| \(-\tfrac{1}{2\mu}\,\partial_{r_1}^{2}\)    | 仅作用于 \(B_k(r_1)\)，给出 \(B_k''(r_1) r_{12}^{c_{ij}^{(0)}}\)      | `I(c_{ij}^{(0)})` |
| \(-\tfrac{1}{\mu}\,r_1^{-1}\partial_{r_1}\) | 仅作用于 \(B_k(r_1)\)，给出 \(B_k'(r_1)/r_1\, r_{12}^{c_{ij}^{(0)}}\) | `I(c_{ij}^{(0)})` |
| \(r_2\) 的同类项                            | 与上对称                                                              | `I(c_{ij}^{(0)})` |

## 6. 混合导数：核心难点解析

几何因子含有 \(r_{12}\)，在施加导数后必须与 \(r_{12}^{c_j}\) 合并，才能匹配到正确的 `I` 积分。这一步是哈密顿量构造中最容易出错的地方。

> **提示**：拆分完成后，请立即标记每一支对应的 `c_{ij}^{(n)}`，再写入代码；否则在多次嵌套循环中很容易把 \(n\) 的偏移记错。

### 6.1 \(\partial_{r_1}\partial_{r_{12}}\) 项

算符：
\[
H_{n} = C_{M\mu}\, \frac{r_1^2 - r_2^2 + r_{12}^2}{r_1 r_{12}}\, \partial_{r_1}\partial_{r_{12}},\qquad C_{M\mu} = \tfrac{1}{2}\left(\tfrac{1}{M}-\tfrac{1}{\mu}\right)
\]

处理步骤：
1. \(\partial_{r_1}\) 作用于 \(B_k\rightarrow B_k'\)，\(\partial_{r_{12}}\) 作用于 \(r_{12}^{c_j}\rightarrow c_j r_{12}^{c_j-1}\)。
2. 将几何因子与新幂次合并：
\[
\frac{r_1^2-r_2^2+r_{12}^2}{r_1 r_{12}}\, r_{12}^{c_j-1} = \frac{r_1^2-r_2^2}{r_1} r_{12}^{c_j-2} + \frac{1}{r_1} r_{12}^{c_j}
\]
3. 与 Bra 侧的 \(r_{12}^{c_i}\) 相乘，出现两个幂次：\(c_{ij}^{(-2)}\) 与 \(c_{ij}^{(0)}\)。

因此该算符拆分为两个 `I` 积分：
- `I(c_{ij}^{(-2)})`：径向系数 \(C_{M\mu}\, c_j \frac{r_1^2-r_2^2}{r_1}\, \frac{B_k' B_l}{B_k B_l}\)
- `I(c_{ij}^{(0)})`：径向系数 \(C_{M\mu}\, c_j \frac{1}{r_1}\, \frac{B_k' B_l}{B_k B_l}\)

实现时，应把两个通道分别累积到 `evaluate_I(c_{ij}^{(-2)})` 与 `evaluate_I(c_{ij}^{(0)})`。

### 6.2 \(\partial_{r_1}\partial_{r_2}\) 项

算符：
\[
H_{n} = C_M\, \frac{r_1^2 + r_2^2 - r_{12}^2}{r_1 r_2}\, \partial_{r_1}\partial_{r_2},\qquad C_M = -\tfrac{1}{4M}
\]

处理步骤：
1. 双导数只作用于样条，得到 \(B_k'(r_1) B_l'(r_2)\)。
2. 几何因子与 \(r_{12}^{c_i + c_j}\) 合并：
\[
\frac{r_1^2 + r_2^2 - r_{12}^2}{r_1 r_2} r_{12}^{c_i+c_j} = \frac{r_1^2 + r_2^2}{r_1 r_2} r_{12}^{c_{ij}^{(0)}} - \frac{1}{r_1 r_2} r_{12}^{c_{ij}^{(2)}}
\]

因此该算符也拆分为两个 `I` 积分：
- `I(c_{ij}^{(0)})`：径向系数 \(C_M \frac{r_1^2 + r_2^2}{r_1 r_2} \frac{B_k' B_l'}{B_k B_l}\)
- `I(c_{ij}^{(2)})`：径向系数 \(-C_M \frac{1}{r_1 r_2} \frac{B_k' B_l'}{B_k B_l}\)

> **常见错误**：忽略第二支 \(c_{ij}^{(2)}\) 会导致动能块在高激发态下偏软，数值验证时表现为能量随基函数数目增加仍偏离基准值。

## 7. 角向耦合 (`J` 积分)

这里需要同时管理径向前因子与角向张量。按论文中三类耦合拆分：

\[
J\big(c_{ij}^{(n)}, q\big) = \int dr_1 dr_2\, B_i B_j B_k B_l\, r_{12}^{c_{ij}^{(n)}}\, \mathcal{A}^{(q)}_{ij}
\]

实现时，`q` 循环外层负责遍历张量分量，内层对 `I` 与 `J` 积分求和。

### 7.1 \((\hat r_1 \cdot \hat\nabla_2^Y)\) — `J_1`

\[
H_{J1} = \left[-\frac{1}{M r_2}\partial_{r_1} + \left(\frac{1}{\mu}-\frac{1}{M}\right)\frac{r_1}{r_2 r_{12}}\partial_{r_{12}}\right] (\hat r_1 \cdot \hat\nabla_2^Y)
\]

- `J(c_{ij}^{(0)})` 通道：径向系数 \(-\tfrac{1}{M r_2}\, \tfrac{B_k' B_l}{B_k B_l}\)，角向系数 `angular.angular_tensor_rhat_grad_12(..., q)`
- `J(c_{ij}^{(-2)})` 通道：径向系数 \(\left(\tfrac{1}{\mu}-\tfrac{1}{M}\right) c_j\, \tfrac{r_1}{r_2}\)，角向同上

### 7.2 \((\hat r_2 \cdot \hat\nabla_1^Y)\) — `J_2`

\[
H_{J2} = \left[-\frac{1}{M r_1}\partial_{r_2} + \left(\frac{1}{\mu}-\frac{1}{M}\right)\frac{r_2}{r_1 r_{12}}\partial_{r_{12}}\right] (\hat r_2 \cdot \hat\nabla_1^Y)
\]

- `J(c_{ij}^{(0)})`：径向系数 \(-\tfrac{1}{M r_1}\, \tfrac{B_k B_l'}{B_k B_l}\)，角向 `angular.angular_tensor_rhat_grad_21`
- `J(c_{ij}^{(-2)})`：径向系数 \(\left(\tfrac{1}{\mu}-\tfrac{1}{M}\right) c_j\, \tfrac{r_2}{r_1}\)，角向同上

### 7.3 \((\hat\nabla_1^Y \cdot \hat\nabla_2^Y)\) — `J_3`

\[
H_{J3} = -\frac{1}{M r_1 r_2} (\hat\nabla_1^Y \cdot \hat\nabla_2^Y)
\]

- 仅贡献 `J(c_{ij}^{(0)})`，径向系数 \(-\tfrac{1}{M r_1 r_2}\)，角向张量 `angular.angular_tensor_grad_grad`

> **实现建议**：对三个角向算符分别写成 `accumulate_J1`, `accumulate_J2`, `accumulate_J3` 小函数，有助于复核前因子且便于单元测试逐一验证。

## 8. 势能项

| 项                                   | 映射到的积分                                                                    |
| ------------------------------------ | ------------------------------------------------------------------------------- |
| \(-\tfrac{2}{r_1} - \tfrac{2}{r_2}\) | `I(c_{ij}^{(0)})`（实现已覆盖）                                                 |
| \(+\tfrac{1}{r_{12}}\)               | `I(c_{ij}^{(-1)})`（新增的电子-电子势通道，需要与 `CorrelationExpansion` 协同） |

## 9. 实现检查清单

- [ ] 对每个算符单独调用 `evaluate_I/J`，避免在同一 integrand 内混杂多个幂次。
- [ ] 混合导数必需先做幂次拆分，分别累到 `c_{ij}^{(-2)}`, `c_{ij}^{(0)}`, `c_{ij}^{(2)}` 通道。
- [ ] 角向耦合保持 `q` 循环外层，径向前因子与角向张量逐项相乘。
- [ ] `CorrelationExpansion` 已支持 \(c = -1\)，确保 `I(c_{ij}^{(-1)})` 的勒让德系数就绪。
- [ ] 数值积分继续复用 `RadialQuadrature2D`。

通过以上步骤，即可把论文中抽象的哈密顿量逐项落地到代码，实现稳定的矩阵元构造。

## 10. 快速对照表

| 通道 | 积分类型           | 典型来源算符                                                        | 径向幂次 \(n\) | 关键系数提示                     |
| ---- | ------------------ | ------------------------------------------------------------------- | -------------- | -------------------------------- |
| A    | `I(c_{ij}^{(-2)})` | \(\partial_{r_{12}}^2\)、\(\partial_{r_1}\partial_{r_{12}}\) 第一支 | -2             | 注意 \(r_1^2-r_2^2\) 符号差      |
| B    | `I(c_{ij}^{(0)})`  | 大部分纯径向导数、混合导数第二支                                    | 0              | 常见于动能与势能的主干项         |
| C    | `I(c_{ij}^{(2)})`  | \(\partial_{r_1}\partial_{r_2}\) 中的 \(-r_{12}^2)\)                | +2             | 系数为 \(-C_M / (r_1 r_2)\)      |
| D    | `I(c_{ij}^{(-1)})` | \(+1/r_{12}\) 势能                                                  | -1             | 依赖 `CorrelationExpansion`      |
| E    | `J(c_{ij}^{(0)})`  | 所有角向耦合的导数项                                                | 0              | 关注 \(-1/M\) 类型的径向因子     |
| F    | `J(c_{ij}^{(-2)})` | 角向耦合中涉及 \(\partial_{r_{12}}\) 的支路                         | -2             | 系数含 \(c_j\) 与 \(r_1/r_2\) 比 |

可按此表核对实现是否覆盖全部通道，尤其是在添加新算符或调试基函数时。

