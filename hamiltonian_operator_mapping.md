# 哈密顿算符积分映射说明

本文档整理论文公式 (2.37) 等与数值实现所需的 `I/J/Q` 积分之间的对应关系，便于在 `MatrixElementBuilder` 中逐项落地。

## 记号约定

- Ket 基函数：\(|\Psi_j\rangle = B_k(r_1) B_l(r_2) r_{12}^{c_j} \Lambda_j(\Omega_1,\Omega_2)\)
- Bra 基函数：\(\langle\Psi_i| = \langle B_i(r_1) B_j(r_2) r_{12}^{c_i} \Lambda_i|\)
- 有效关联幂：\(c_{ij}^{(n)} = c_i + c_j + n\)
- 样条导数：`B_k'`, `B_k"` 等对应代码中的一阶、二阶导数
- 角向积分：\(\mathcal{A}^{(\cdot)}_{ij}(q)\) 表示论文给出的角向张量（代码中由 `angular_tensor_*` 函数提供）

## 1. 纯 \(r_{12}\) 导数项

| 算符                                                                     | 作用结果（系数）                                        | 积分类型             |
| ------------------------------------------------------------------------ | ------------------------------------------------------- | -------------------- |
| \((\tfrac{1}{M}-\tfrac{1}{\mu})\,\partial_{r_{12}}^{2}\)                 | \(c_j(c_j-1)\,r_{12}^{c_j-2}\)                          | \(I(c_{ij}^{(-2)})\) |
| \(2(\tfrac{1}{M}-\tfrac{1}{\mu})\,\tfrac{1}{r_{12}}\partial_{r_{12}}\)   | \(2(\tfrac{1}{M}-\tfrac{1}{\mu})\,c_j\,r_{12}^{c_j-2}\) | \(I(c_{ij}^{(-2)})\) |
| 质量极化中的 \(-\partial_{r_{12}}^{2} - 2 r_{12}^{-1}\partial_{r_{12}}\) | 分别产生 \(-c_j(c_j-1)\)、\(-2c_j\)                     | \(I(c_{ij}^{(-2)})\) |

这些项累加后全部映射到同一个 `I` 积分，区别只在于系数。

## 2. 纯 \(r_1\)、\(r_2\) 导数项

论文式 (2.37) 中的 \(\partial/\partial r_1\)、\(\partial^2/\partial r_1^2\) 等算符已经在坐标变换后独立定义，不再对 \(r_{12}\) 施加链式法则。因此：

| 算符                                        | 作用结果                                                    | 对应积分            |
| ------------------------------------------- | ----------------------------------------------------------- | ------------------- |
| \(-\tfrac{1}{2\mu}\,\partial_{r_1}^{2}\)    | 仅作用于 \(B_k(r_1)\)，得到 \(B_k''(r_1)\,r_{12}^{c_j}\)    | \(I(c_{ij}^{(0)})\) |
| \(-\tfrac{1}{\mu}\,r_1^{-1}\partial_{r_1}\) | 仅作用于 \(B_k(r_1)\)，得到 \(B_k'(r_1)/r_1\,r_{12}^{c_j}\) | \(I(c_{ij}^{(0)})\) |
| \(r_2\) 的同类项                            | 对称于上                                                    | \(I(c_{ij}^{(0)})\) |

所有涉及 \(r_1\) 或 \(r_2\) 的纯径向导数都只在样条函数上产生导数，\(r_{12}\) 幂次保持不变。

## 3. 混合二阶导数项

| 算符                                                                                                                   | 行为                                                                                                                         | 积分类型           |
| ---------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | ------------------ |
| \(\tfrac{1}{2}(\tfrac{1}{M}-\tfrac{1}{\mu})\tfrac{r_1^2-r_2^2+r_{12}^2}{r_1 r_{12}}\,\partial_{r_1}\partial_{r_{12}}\) | \(\partial_{r_1}\) 作用于样条 \(B_k\)，\(\partial_{r_{12}}\) 作用于 \(r_{12}^{c_j}\)，得到 \(B_k'(r_1)\,c_j r_{12}^{c_j-1}\) | `I(c_{ij}^{(-1)})` |
| \(\tfrac{1}{2}(\tfrac{1}{M}-\tfrac{1}{\mu})\tfrac{r_2^2-r_1^2+r_{12}^2}{r_2 r_{12}}\,\partial_{r_2}\partial_{r_{12}}\) | 同理（互换 1,2）                                                                                                             | `I(c_{ij}^{(-1)})` |
| \(-\tfrac{1}{2M}\tfrac{r_1^2+r_2^2-r_{12}^2}{2 r_1 r_2}\,\partial_{r_1}\partial_{r_2}\)                                | \(\partial_{r_1}\partial_{r_2}\) 仅作用于样条，产生 \(B_k'(r_1) B_l'(r_2) r_{12}^{c_j}\)                                     | `I(c_{ij}^{(0)})`  |

几何系数中的 \(r_1,r_2,r_{12}\) 需借助勒让德展开重写为 \(r_<, r_>\) 幂次组合。

## 4. 角向耦合项

| 算符                                                                                                                                       | 作用结果                                                                | 积分类型                                |
| ------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------- | --------------------------------------- |
| \([-\tfrac{1}{M r_2}\partial_{r_1} + (\tfrac{1}{\mu}-\tfrac{1}{M})\tfrac{r_1}{r_2 r_{12}}\partial_{r_{12}}](\hat r_1\cdot\hat\nabla_2^Y)\) | 分别得到 \(B_k' r_{12}^{c_j}\) 与 \(B_k c_j r_{12}^{c_j-2}\) 乘角向张量 | `J(c_{ij}^{(0)})` 与 `J(c_{ij}^{(-2)})` |
| \([-\tfrac{1}{M r_1}\partial_{r_2} + (\tfrac{1}{\mu}-\tfrac{1}{M})\tfrac{r_2}{r_1 r_{12}}\partial_{r_{12}}](\hat r_2\cdot\hat\nabla_1^Y)\) | 同理                                                                    | 同理                                    |
| \(-\tfrac{1}{M r_1 r_2}(\hat\nabla_1^Y\cdot\hat\nabla_2^Y)\)                                                                               | 无径向导数，仅角向张量 × \(r_{12}^{c_j}\)                               | `J(c_{ij}^{(0)})`                       |

哈密顿量本身不涉及 `Q` 型积分（那是偶极算符相关的扩展）。

## 5. 势能项

| 项                                   | 映射                                                   |
| ------------------------------------ | ------------------------------------------------------ |
| \(-\tfrac{2}{r_1} - \tfrac{2}{r_2}\) | 直接对应 `I(c_{ij}^{(0)})`（当前实现已正确处理）       |
| \(+\tfrac{1}{r_{12}}\)               | 映射到 `I(c_{ij}^{(-1)})`，即我们已新增的电子-电子势项 |

---

## 实现建议

1. **结构拆分**：在 `MatrixElementBuilder` 中按算符分组实现，对每个算符调用统一的 `evaluate_I/J` 助手，避免在单个 `integrand` 内混杂所有逻辑。
2. **复用现有组件**：`CorrelationExpansion`（已支持 \(c=-1\)）负责生成勒让德展开系数；`angular_tensor_*` 提供角向积分；`RadialQuadrature2D` 继续承担数值求积。
3. **验证流程**：在小基组（如 \(c=0\)、\(l_1=l_2=0\)）上逐项开启/关闭，核对能量与参考数据，确保每个块输出正确。

整理完毕，可用来校验代码或作为后续实现的对照表。
