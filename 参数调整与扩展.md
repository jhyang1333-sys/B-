# 参数调整与扩展

## 1\. 参数详解：你可以调节什么？

本项目有两种调节方式：**物理参数**（需修改代码）和 **运行参数**（命令行后缀）。

### 1.1 物理参数 (硬编码)

为了防止误操作导致物理结果不一致，核心物理参数硬编码在 `scripts/run_energy_pipeline.py` 的 `main()` 函数顶部。

**请使用编辑器打开文件修改以下变量：**

```python
# scripts/run_energy_pipeline.py

tau = 0.038         # 节点分布参数 (控制 B 样条节点在原点附近的密集程度)
r_max = 200.0       # 盒子半径 (a.u.)。注意：必须 >= 150.0 才能支持 diffuse 态
k = 7               # B 样条阶数。建议 >= 7 (高阶样条精度更高)
n = 20              # 节点数量。精度核心指标，计算量随 n^2 增长
l_max = 2           # 角动量截断。l_max=2 包含 s,p,d 波；l_max=4 包含 s,p,d,f,g
```

> **温馨提示**：不要使用“小盒子+多节点”的组合（如 `r_max=20, n=20`），这会导致严重的线性相关和矩阵奇异。`r_max` 必须足够大。

### 1.2 运行参数 (命令行全集)

所有脚本均支持 `-h` 查看帮助。以下是 **`run_energy_pipeline.py`** 支持的完整参数列表。

#### A. 基础与缓存控制

| 参数命令              | 默认值         | 作用描述                                             |
| :-------------------- | :------------- | :--------------------------------------------------- |
| `--num-eigenvalues N` | `5`            | 计算并存储最低的 N 个能级。                          |
| `--progress`          | `False`        | 显示矩阵装配的进度条（推荐开启）。                   |
| `--use-cache`         | `True`         | 优先读取 `cache/` 下的旧结果。                       |
| `--no-cache`          | `False`        | **强制禁用缓存**。修改代码逻辑后请务必使用此项。     |
| `--refresh-cache`     | `False`        | 计算完成后强制覆盖旧缓存文件。                       |
| `--cache-dir DIR`     | `cache`        | 指定缓存根目录。                                     |
| `--cache-key NAME`    | `energy_small` | 缓存子目录名。可用于区分不同参数集（如 `run_n50`）。 |

#### B. 并行与性能 (核外计算)

| 参数命令                  | 默认值 | 作用描述                                                |
| :------------------------ | :----- | :------------------------------------------------------ |
| `--assembly-workers N`    | `Auto` | 并行核心数。默认使用所有可用 CPU 核心。                 |
| `--assembly-chunk-rows N` | `Auto` | 每个任务块包含的行数。**内存不足时调小此值** (如 100)。 |

> **核外计算机制**：程序会自动在 `cache/assembly_chunks/` 创建临时目录，将计算好的矩阵块写入 SSD。这允许在 128GB 内存的机器上处理 16TB 的矩阵数据。

#### C. 数值稳定性 (防止发散的关键)

Hylleraas 基组天然存在线性相关（病态）。以下参数控制 **“规范正交化”** 和 **“重叠矩阵调节”**，是解决发散问题的核心。

| 参数命令                                | 默认值  | 作用描述                                                                     | 调节建议                      |
| :-------------------------------------- | :------ | :--------------------------------------------------------------------------- | :---------------------------- |
| `--channel-ortho-tol`                   | `1e-10` | **通道正交化阈值**。特征值小于此值的基函数会被丢弃。                         | 若发散，尝试 `1e-8` 或 `1e-7` |
| `--channel-ortho-max-dim`               | `512`   | 通道块的最大维度，超过此值将跳过密集分解。                                   | 保持默认即可                  |
| `--disable-channel-orthogonalization`   | `False` | 禁用通道正交化（仅用于调试）。                                               | **不要使用**                  |
| `--overlap-conditioning-tol`            | `1e-10` | **全局重叠矩阵调节阈值**。                                                   | 与 ortho-tol 保持一致         |
| `--overlap-conditioning-mode`           | `auto`  | 调节策略：`auto` (自动), `dense` (强制稠密分解), `regularize` (仅对角加数)。 | 极大规模时用 `regularize`     |
| `--overlap-conditioning-regularization` | `1e-8`  | 当模式为 `regularize` 时，对角线添加的 epsilon 值。                          | `1e-8` 到 `1e-6`              |

#### D. 绘图专用参数 (`plot_dynamic_polarizability.py`)

| 参数命令         | 默认值        | 作用描述                |
| :--------------- | :------------ | :---------------------- |
| `--freq-max VAL` | `0.8`         | 扫描的最大频率 (a.u.)。 |
| `--freq-count N` | `40`          | 扫描的频率点数。        |
| `--output PATH`  | `outputs/...` | 图片保存路径。          |

-----

## 2\. 典型使用场景 (Copy & Paste)

### 场景 1：标准运行 (Linux 云服务器)

适用于 `N=20` 或更高的大规模计算。利用核外计算和自动稳定化。

```bash
# 强制重新计算，开启进度条，使用 32 核
python scripts/run_energy_pipeline.py \
    --no-cache \
    --progress \
    --assembly-workers 32 \
    --cache-key energy_n20_production
```

### 场景 2：解决发散问题 (强力去噪模式)

如果你发现算出的能量是 $-10^7$ 或 `nan`，说明基组太病态。使用更激进的截断阈值和稠密分解模式。

```bash
python scripts/run_energy_pipeline.py \
    --no-cache \
    --progress \
    --channel-ortho-tol 1e-7 \
    --overlap-conditioning-tol 1e-7 \
    --overlap-conditioning-mode dense \
    --overlap-conditioning-max-dim 10000
```

### 场景 3：在 Windows 上进行小规模调试

Windows 的 `spawn` 进程启动开销巨大，必须限制核心数并使用小参数（需先在代码中改小 `n` 和 `r_max`）。

```bash
# 限制为 4 核，防止内存爆炸
python scripts/run_energy_pipeline.py \
    --assembly-workers 4 \
    --progress
```

### 场景 4：只画图 (复用已有数据)

不想重新算矩阵，只想调整绘图频率范围。

```bash
# 扫描到 1.2 a.u.，采样 100 个点
python scripts/plot_dynamic_polarizability.py \
    --freq-max 1.2 \
    --freq-count 100 \
    --output outputs/high_res_plot.png
```

-----

## 3\. 性能调节

### 3.1 内存与磁盘

  - **内存 (RAM)**：
      - **Linux (`fork`)**：启动 32 核仅需主进程内存（约 40GB）。主要内存消耗在最后一步的主进程矩阵合并（取决于 `scipy.sparse.vstack`）。
      - **Windows (`spawn`)**：启动 32 核需要 **巨大** 内存。**极其危险**。
  - **磁盘 (SSD)**：
      - 启用核外计算后，中间结果写入 `cache/assembly_chunks/`。
      **请确保磁盘有足够空间！！！**（记得估算一下）

### 3.2 并行策略

代码默认使用 `multiprocessing.Pool`。

  - **Linux**：在 `src/he_polarization/hamiltonian/elements.py` 中，代码自动检测并使用 `ctx = mp.get_context(None)` (即 fork)，效率最高。
  - **Windows**：强制使用 `spawn`。建议安装 WSL2 (Windows Subsystem for Linux) 来运行本项目，以获得 Linux 的性能优势。

-----

## 4\. 常见问题排查

**Q: 报错 `ZeroDivisionError` 或 `eta = 1.0`？**

  * **A**: 求解器找到了“幽灵态”。
    1.  检查 `scripts/run_energy_pipeline.py` 中是否启用了 `solver_config` 的 `sigma=-2.90372` (Shift-Invert 模式)。
    2.  增大 `--channel-ortho-tol` (试 `1e-8`)。
    3.  检查 `r_max` 是否太小 (必须 \>= 150)。

**Q: 运行 `pip install -e .` 报错 `pyproject.toml not found`？**

  * **A**: 请确保你在项目的**根目录**下执行命令（即包含 `README.md` 和 `pyproject.toml` 的那个文件夹）。

**Q: 进度条为什么是跳跃的？**

  * **A**: 因为使用了“任务块”机制。每个 Worker 只有在算完一整个块（比如 500 行矩阵元）并写入磁盘后，才会汇报一次进度。这是为了减少通信开销。

**Q: 为什么结果和论文有微小差异？**

  * **A**: 检查物理参数。论文通常使用无限核质量 ($M=\infty$)，而本代码默认使用真实氦核质量 ($M \approx 7294$)。这会带来 $10^{-4}$ a.u. 的能量位移。

